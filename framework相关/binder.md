## binder

### 1、binder是什么？

binder是一种跨进程通信的方式。它的原理实现是把一块内核空间的区域映射到B用户进程，使得A进程向B进程发送数据时，先将数据拷贝到内核空间，由于存储数据的内核空间同时也映射到了B进程，B进程也就拿到了A进程发送过来的数据，即实现了跨进程通信。

具体工作流程是什么？

- 服务注册

  服务端进程创建一个binder实体，然后将这个服务名称和这个binder实体注册到serviceManager

- 服务获取

  客户端通过调用serviceManager的方法，传入需要获取的服务名称。接着serviceManager查找对应的binder实体，然后返回一个binder的代理对象给客户端。

- 服务调用

  客户端接着调用代理对象的方法，代理对象将方法参数打包发送给binder驱动，binder驱动根据句柄找到目标服务器进程，然后服务端对接收到的请求和数据进行解包，调用该接口的具体实现方法。如果有执行结果也会通过类似的路径（序列化->binder驱动->反序列化） 返回给客户端。

这里有一个疑问，客户端要先和serviceManager通信，他们间的通信如何实现？

- serviceManager本身也是一个binder服务，它的句柄是0。这是一个约定。

  当客户端要和serviceManager通信时，会构造一个指向句柄0的binder请求，当binder驱动拿到这个请求后，看到句柄是0，会直接发给serviceMagager。

那么客户端如何获得serviceManager的通信呢？

- 当一个 Android 进程启动并初始化其 Binder 通信环境时（这通常由 Android Framework 在应用启动的早期阶段完成），它会自动获得一个与 ServiceManager 通信的 `IBinder` 代理对象。

### 2、binder驱动是什么？

结合上面的描述，binder驱动实际上就是一个中转站，它运行在linux内核空间。当不同进程间进行通信的时候，实际上都是通过binder驱动进行中转的。

binder驱动在linux内核启动过程中就已经初始化了。它是操作系统核心功能的一部分。

### 3、详细介绍一下服务注册这个流程

本质上是服务端和serviceMagager的通信，其中也需要binder驱动来参与。

binder驱动会把服务端传来的binder实体进行处理，会在内核中给他创建一个唯一的、内核级别的引用。这个引用就叫“句柄”。

接着binder驱动会把这个句柄传给serviceManager，最后serviceManager会把这个服务名称和binder引用进行存储。

后续其他进程拿到这个binder引用后，binder驱动就能根据这个引用找到对应的服务端进程。

**简单来说，可以将 Binder 引用想象成：**

你（客户端）想去一家大公司的某个特定部门（服务端的 Binder 对象）办事。你不能直接闯进那个部门的办公室。

1. 你首先要去公司的前台（ServiceManager）问路。
2. 前台会给你一张访客证（**Binder 引用/句柄**），上面写着你要去的部门的内部通行码。这张访客证本身不是那个部门，但它代表了你访问那个部门的许可和路径。
3. 公司的安保系统（**Binder 驱动**）会根据你访客证上的通行码，引导你到正确的部门。
4. 当你办完事离开时，你交回访客证（释放引用），公司就知道你不再访问那个部门了（引用计数减少）。



